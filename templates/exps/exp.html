{% extends 'new_project.html' %} 
{% load static %} 
{% block project_name %}
{{project.project_name }} 
{% endblock %} 
{% block exp_block %} 
<div id="formMessages" class="mt-3"></div>
<style>
    .gradient-custom {
/* fallback for old browsers */
background: #343434;
/* Chrome 10-25, Safari 5.1-6 */
background: -webkit-linear-gradient(to right bottom, rgb(41, 41, 41), rgb(126, 123, 123));
/* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
background: linear-gradient(to right bottom, rgb(21, 20, 18), rgb(195, 195, 195))
}
</style>
<div id="loading-wrapper" style="display: none;">
  <div id="loading"></div>
</div>
{% if experiments%}
<div class="container">
    <div class="container p-3 card bg-white rounded mb-5">
      <div class="row justify-content-between align-content-between card-body">
        <div class="col-md">
          <h2 class="font-weight-bold text-black fs-1">
            Experiments
          </h2>
          <div class="d-md-flex flex-wrap">
            <p class="text-break mb-md-3 mr-md-3" style="max-width: calc(100% - 150px);">
              Echo platform provides you with the necessary tools and resources needed to streamline your machine learning workflows. Leverage automated pipelines for data processing, model training, and evaluation, reducing the time-to-market for your AI solutions.
            </p>
          </div>
          <a id="openModalBtn" class="btn article"><i class="fa fa-flask" aria-hidden="true"></i> New Experiment</a>
        </div>
        <div class="col-md-auto d-flex justify-content-end">
          <img src="https://www.kdnuggets.com/wp-content/uploads/wijaya_top_machine_learning_papers_read_2023_1.jpg" alt="Image Description" class="img-fluid d-none d-md-inline-block" style="max-width: 300px; max-height: 300px;">
        </div>
      </div>
        <form action="">  
          <div class="input-group mb-2">  
            <input type="search" placeholder="Search here..." aria-describedby="button-addon5" class="form-control">  
            <div class="input-group-append">  
              {% comment %} <a id="button-addon5" type="submit" class="btn article"> <i class="fa fa-search"> </i> </a>   {% endcomment %}
            </div>
        </form>
    </div>
  </div>
  
  <div class="d-flex justify-content-end mb-5">
    <div class="btn-group" id="btnGroup" role="group">
        <button type="button" class="btn btn-outline-dark active" data-filter="all">All</button>
        <button type="button" class="btn btn-outline-dark" data-filter="active">Active</button>
        <button type="button" class="btn btn-outline-dark" data-filter="completed"><span class="row justify-content-center">Completed</span></button>
        <button type="button" class="btn btn-outline-dark" data-filter="stopped">Stopped</button>
    </div>
</div>

<div class="row">
  {% for experiment in experiments %}
    <div class="col-md-3 mb-4">
      <!-- Use MDB's card classes for styling -->
      <div class="card h-100">
        
        <!-- Card Image -->
        <img src="{{ experiment.random_image_url }}" class="card-img-top" alt="Experiment Image">

        <!-- Card Body -->
        <div class="card-body d-flex flex-column">
          <!-- Experiment Name -->
          <h5 class="card-title text-truncate" style="font-weight: bold; font-size: 16px;">{{ experiment.name }}</h5>
          
          
          <hr>

          <!-- Experiment Creation date -->
          <div class="d-flex justify-content-between mb-2">
            <p class="mb-0" style="color: #343434; font-weight: bold; font-size: 12px;">Created At:</p>
            <p class="mb-0 text-info" style="font-weight: bold; font-size: 12px;">
              {{ experiment.created_at }}
            </p>
          </div>    
        
          <!-- Experiment Status -->
          <div class="d-flex justify-content-between mb-2">
            <p class="mb-0" style="color: #343434; font-weight: bold; font-size: 12px;">Status:</p>
            <p class="mb-0 {% if experiment.status == 'active' %}text-success{% else %}text-danger{% endif %}" style="font-weight: bold; font-size: 12px;">
              {{ experiment.get_status_display }}
            </p>
          </div>           
          
          <!-- Experiment Description -->
          {% comment %} <p class="card-text text-truncate">{{ experiment.description }}</p> {% endcomment %}

          <!-- Align items to the bottom using mt-auto in Flexbox -->
          <div class="mt-auto">
            <a href="{% url 'view_experiment' experiment.id %}" class="btn btn-secondary btn-block">View Experiment</a>
          </div>
        </div>

        <!-- Delete Icon - Positioned within the card-body for consistent alignment -->
        <div class="card-footer text-right">
          <a href="javascript:void(0);" class="text-danger delete-icon" data-experiment-id="{{ experiment.id }}" data-experiment-name="{{ experiment.name }}">
            <i class="fa fa-trash"></i>
          </a>
        </div>

      </div>
    </div>
    {% if forloop.counter|divisibleby:4 and not forloop.last %}
      <!-- Ensure that new rows are created correctly by handling this in the template logic or with CSS -->
    {% endif %}
  {% endfor %}
</div>

  
  <!-- Place the confirmation modal outside the loop, so it's only included once -->
  <div id="deleteConfirmationModal" class="modal">
    <div class="modal-content card text-center">
      <h5 class="card-header">Confirm Deletion</h5>
      <div class="card-body">
        <p class="card-text" style="color: #343434;" id="deleteMessage">Deleting the experiment "<span id="experimentNamePlaceholder"></span>" will delete all models and training jobs associated with your model.</p>
      </div>
      <div class="card-footer modal-buttons justify-content-between" style="display: flex; gap: 10px;">
          <button id="cancelDelete" class="btn btn-secondary">Cancel</button>
          <button id="confirmDelete" class="btn btn-danger">Delete</button>
        </div>
    </div>
  </div>
  
    
</div>
       
  {% comment %} </div> {% endcomment %}
  
{% else %}
<div class="center-container container-fluid">
  <img
    src="{% static 'images/empty.png' %}"
    alt="No projects available"
    width="350"
    height="350"
    class="img-fluid p-5"
  />
  <h6 class="font-weight-bold">
    No Experiments
  </h6>
  <div class="paragraph-wrapper text-center">
    <p>
      No experiments found. Press new experiment to create a new machine learning experiment for your
      project
    </p>
  </div>
  <a id="openModalBtn" class="btn article"><i class="fa fa-flask" aria-hidden="true"></i> New Experiment</a>
</div>
</div>
  </div>
{% endif %} 
<!-- The Modal -->
<div id="myModal" class="modal">
    <!-- Modal content -->
    <div class="modal-content p-5">
        <span class="close" style="color: red; font-weight: 900;">&times;</span>
        <div class="title-container">
            <h2 class="modal-title">Add New Experiment</h2>
        </div>
        <form id="experimentForm" action="{% url 'submit_experiment' %}" method="post" class="modal-form needs-validation" novalidate onsubmit="loadingPage()">
          {% csrf_token %}
            <label for="experimentName">Experiment Name:</label>
            <input type="text" id="experimentName" name="experimentName" class="form-control" required>
            <div class="valid-feedback">Looks good!</div>
            <div class="invalid-feedback">Please provide a valid experiment name.</div>
            
            <label for="experimentDescription">Why it matter?</label>
            <textarea id="experimentDescription" name="experimentDescription" class="form-control" required></textarea>
            <div class="valid-feedback">Looks good!</div>
            <div class="invalid-feedback">Please provide a valid experiment description.</div>
            
            <div class="justify-content-center px-5 pt-3">
                    {% comment %} <a href="#" class="btn btn-sm btn-secondary cancel-btn" style="color: black;">Cancel</a> {% endcomment %}
                    <button type="submit" class="btn btn-sm article">Next</button>
                
            </div>
        </form>
    </div>
</div>
<style>
  #loading {
    position: absolute;
    left: 50%;
    top: 50%;
    z-index: 1;
    width: 150px;
    height: 150px;
    margin: -75px 0 0 -75px;
    border: 16px solid #f3f3f3;
    border-radius: 50%;
    border-top: 16px solid #FFFFFF;
    width: 120px;
    height: 120px;
    animation: spin 2s linear infinite;
  }
  
  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }  
    .title-container {
        text-align: center; /* Center the title */
        margin-bottom: 20px; /* Add some space below the title */
        background-color: #02310D; /* Green background color */
        padding:10px;
    }
    .modal-title {
        color: white; /* Title color */
        margin: 0; /* Remove default margin */
    }
    button.article{
      background: #025A42 !important;
      color: #fff !important;
    }
    button.article:hover {
      background: #037D5C !important;
      color: #fff !important;
    }
/* Style Cancel button */
.cancel-btn {
    margin-right: 5px; /* Add margin between buttons */
}

/* Ensure close button is aligned properly */
.close {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 24px;
    color: #aaa;
}
    /* The Modal (background) */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  }
  
  /* Modal Content/Box */
  .modal-content {
    background-color: #fefefe;
    margin: 15% auto; /* 15% from the top and centered */
    padding: 20px;
    padding-bottom: 0px;
    border: 1px solid #888;
    width: 25%; /* Could be more or less, depending on screen size */
  }
  
  /* Close Button */
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }
  
  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }
  
    .modal-backdrop {
        filter: blur(2px);
    }
   /* Adjust modal content width for mobile responsiveness */
   /* Adjust modal content for mobile responsiveness */
@media (max-width: 768px) {
    .modal-content {
      width: 90%; /* Set a percentage width for smaller screens */
      max-width: 90%; /* Ensure maximum width for smaller screens */
    }
  
    #experimentForm label {
      font-size: 14px; /* Reduce label font size for smaller screens */
    }
  
    #experimentForm input[type="text"],
    #experimentForm textarea {
      font-size: 14px; /* Reduce input font size for smaller screens */
      padding: 8px; /* Reduce padding for smaller screens */
    }
  
    #experimentForm button {
      font-size: 14px; /* Reduce button font size for smaller screens */
      padding: 8px; /* Reduce padding for smaller screens */
    }
  }
  
  /* Add new style for form fields */
  #experimentForm label {
    display: block; /* Display labels as block elements */
    margin-bottom: 5px; /* Add some margin between labels */
  }
  
  #experimentForm input[type="text"],
  #experimentForm textarea {
    width: 100%; /* Make input fields occupy full width */
    margin-bottom: 10px; /* Add margin between input fields */
  }
  
  #experimentForm button {
    width: 100%; /* Make button occupy full width */
  }
      .logo {
        max-width: 150px;
        display: block;
      }
      
      small {
        color: lightgray;
      }
      
      .btn {
        background-color: white;
        padding: 1em 1.5em;
        border-radius: 0.5rem;
        text-decoration: none;
        i {
          padding-right: 0.3em;
        }
      }
    .btn-outline-dark {
        width: 120px; /* Adjust width as needed */
    }

    .card-img-top {
        width: 100%;
        height: 6vw;
        object-fit: cover;
    }

    .card-title {
        font-size: 15px;
        font-weight: bold;
    }

    .card-exp {
        transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Add shadow */
    }

    .card-exp:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2); /* Increase shadow on hover */
    }

    .dataset {
        color: black;
        font-weight: 400;
        font-size: 12px;
    }
.alert {
  padding: 20px;
  background-color: #f44336;
  color: white;
  opacity: 1;
  transition: opacity 0.6s;
  margin-bottom: 15px;
}

.closebtn {
  margin-left: 15px;
  color: white;
  font-weight: bold;
  float: right;
  font-size: 22px;
  line-height: 20px;
  cursor: pointer;
  transition: 0.3s;
}

.closebtn:hover {
  color: black;
}

/* The Close Button */
.close {
  color: #aaaaaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

/* Buttons inside the modal */
.modal-content button {
  margin-top: 15px;
  padding: 10px;
  width: 120px;
}

#confirmDelete {
  background-color: red;
  color: white;
  border: none;
}

#cancelDelete {
  background-color: gray;
  color: white;
  border: none;
}

</style>
<script>
// Get the modal
var modal = document.getElementById("myModal");

// Get the button that opens the modal
var btn = document.getElementById("openModalBtn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks on the button, open the modal
btn.onclick = function() {
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}

// JavaScript for closing modal on Cancel button click
document.addEventListener("DOMContentLoaded", function() {
    const cancelBtn = document.querySelector(".cancel-btn");
    const modal = document.getElementById("myModal");

    cancelBtn.addEventListener("click", function(event) {
        event.preventDefault();
        modal.style.display = "none";
    });
});


document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("experimentForm");
  var baseUrl = window.location.origin;

  form.addEventListener("submit", function (event) {
      event.preventDefault();

      // Validate form inputs before submitting
      const experimentName = form.querySelector("[name='experimentName']").value.trim();
      const experimentDescription = form.querySelector("[name='experimentDescription']").value.trim();

      // Clear previous messages
      clearMessages();

      // Check if the experiment name or description is empty and display an error message
      if (!experimentName || !experimentDescription) {
          displayMessage("Experiment name and description cannot be empty.", "danger"); // Display error message
          return; // Stop the form submission
      }

      // Display loading screen
      showLoading();

      fetch(form.action, {
          method: form.method,
          body: new FormData(form)
      })
      .then(response => response.json())
      .then(data => {
          if (data.success) {
              var newUrl = baseUrl + '/experiment/' + data.exp_id + '/';
              setTimeout(function() {
                  window.location.replace(newUrl);
              }, 2000);
          } else {
              displayMessage("An error occurred while submitting the form.", "danger");
          }
      })
      .catch(error => {
          displayMessage("Failed to submit the form.", "danger");
      });
  });

  function showLoading() {
      // Implementation remains the same
  }

  function displayMessage(message, type) {
    const messagesDiv = document.getElementById('formMessages');
    const messageElement = document.createElement('div');
    messageElement.className = `alert alert-${type}`;
    messageElement.textContent = message;
    messagesDiv.appendChild(messageElement);

    // Remove the message after 3 seconds
    setTimeout(() => {
        messagesDiv.removeChild(messageElement);
    }, 3000); // 3000 milliseconds = 3 seconds
}


  function clearMessages() {
      const messagesDiv = document.getElementById('formMessages');
      messagesDiv.innerHTML = ''; // Remove all child elements
  }
});


document.addEventListener("DOMContentLoaded", function () {
  const filterButtons = document.querySelectorAll("#btnGroup button");
  const cards = document.querySelectorAll(".row .col-md-3.mb-4");

  filterButtons.forEach(function(button) {
      button.addEventListener("click", function() {
          const filter = this.getAttribute("data-filter");

          cards.forEach(function(card) {
              // Assuming a data-status attribute is available for filtering.
              const status = card.querySelector('.card-body p').classList.contains('text-success') ? 'active' : 
                             (card.querySelector('.card-body p').classList.contains('text-danger') ? 'stopped' : 'unknown');
              if (filter === 'all' || status === filter) {
                  card.style.display = "block";
              } else {
                  card.style.display = "none";
              }
          });

          // Update active button styling
          filterButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
      });
  });
});

  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.querySelector(".form-control");
    searchInput.addEventListener("input", function () {
        const searchTerm = this.value.trim().toLowerCase();
        // Target the '.card h-100' elements inside the row div for each experiment card
        const cards = document.querySelectorAll(".row .col-md-3.mb-4 .card.h-100");

        cards.forEach(function (card) {
            // We can keep the rest of your JS logic the same, as the querySelector part was the issue
            const experimentNameElement = card.querySelector(".card-title");
            if (experimentNameElement) {
                const experimentName = experimentNameElement.textContent.trim().toLowerCase();
                if (experimentName.includes(searchTerm)) {
                    card.parentElement.style.display = "block"; // Show the entire column
                } else {
                    card.parentElement.style.display = "none"; // Hide the entire column
                }
            }
        });
    });
});

    function filterCards(filter) {
        const cards = document.querySelectorAll(".experiment-card");

        cards.forEach(function (card) {
            if (filter === "all") {
                card.style.display = "block";
            } else {
                const status = card.getAttribute("data-status");
                if (status === filter) {
                    card.style.display = "block";
                } else {
                    card.style.display = "none";
                }
            }
        });
    }

    function toggleActiveButton(buttons, activeButton) {
        buttons.forEach(function (button) {
            button.classList.remove("active");
        });
        activeButton.classList.add("active");
    }
      document.addEventListener("DOMContentLoaded", function () {
          const deleteIcons = document.querySelectorAll(".delete-icon");
          const modal = document.getElementById("deleteConfirmationModal");
          const closeModal = modal.querySelector(".close");
          const confirmDelete = document.getElementById("confirmDelete");
          const cancelDelete = document.getElementById("cancelDelete");
          const deleteMessage = modal.querySelector("#deleteMessage"); // Ensure you have a placeholder for the message
          let currentExperimentId = null; // To keep track of the experiment to delete
          let experimentName = ""; // To store the experiment's name for messaging

          confirmDelete.addEventListener("click", function() {
            if(currentExperimentId) {
              console.log("XPxperiment selected for deletion.");
                deleteExperiment(currentExperimentId); // Call delete function with the current ID
            } else {
                console.log("No experiment selected for deletion.");
            }
        });
  
          deleteIcons.forEach(icon => {
              icon.addEventListener("click", function(e) {
                  e.preventDefault(); // Prevent any default action
                  currentExperimentId = this.dataset.experimentId; // Set the current experiment ID
                  experimentName = this.dataset.experimentName; // Get the experiment's name
                  deleteMessage.textContent = `Are you sure you want to delete the experiment "${experimentName}"? This action cannot be undone.`; // Update the modal message
                  modal.style.display = "block"; // Show the modal
              });
          });
  
          // When the user clicks on <span> (x) or Cancel, close the modal
          closeModal.onclick = cancelDelete.onclick = function() {
              modal.style.display = "none";
          }
  
          // Confirm Deletion
    confirmDelete.addEventListener("click", function() {
      if(currentExperimentId) {
          deleteExperiment(currentExperimentId); // Call delete function with the current ID
      }
  });
      });
      function deleteExperiment(experimentId) {

      // Log the experiment ID to the console (or perform any action you need with it)
      console.log('Experiment ID to delete:', experimentId);
        var url = `/experiment/delete/${experimentId}/`; 
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if(data.success) {
                window.location.reload(true);
                //alert(data.message);
            } else {
                alert(data.message); // Show error message if deletion wasn't successful
            }
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }   

  </script>


{% endblock %}
